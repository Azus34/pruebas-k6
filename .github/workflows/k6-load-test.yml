name: K6 Load Testing Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL base de la aplicaciÃ³n a probar'
        required: false
        default: 'https://fps-api-production.up.railway.app'
      test_duration:
        description: 'DuraciÃ³n de la prueba'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - extended

jobs:
  k6_load_test:
    name: Ejecutar Pruebas de Carga K6
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar K6
        run: |
          cd /tmp
          wget -q https://github.com/grafana/k6/releases/download/v0.53.0/k6-v0.53.0-linux-amd64.tar.gz
          tar xzf k6-v0.53.0-linux-amd64.tar.gz
          sudo mv k6-v0.53.0-linux-amd64/k6 /usr/local/bin/
          chmod +x /usr/local/bin/k6

      - name: âœ… Verificar instalaciÃ³n
        run: k6 version

      - name: ğŸ¯ Configurar variables de entorno
        run: |
          BASE_URL="${{ github.event.inputs.base_url || 'https://fps-api-production.up.railway.app' }}"
          echo "BASE_URL=${BASE_URL}" >> $GITHUB_ENV
          echo "TEST_DURATION=${{ github.event.inputs.test_duration || 'standard' }}" >> $GITHUB_ENV
          echo "ğŸ“ BASE_URL configurada como: ${BASE_URL}"

      - name: ğŸ” Validar token de Grafana Cloud
        run: |
          if [ -z "$K6_CLOUD_TOKEN" ]; then
            echo "âŒ ERROR: El secret K6_CLOUD_TOKEN no estÃ¡ configurado"
            exit 1
          fi
          echo "âœ… Token de Grafana Cloud validado"
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}

      - name: ğŸ§ª Verificar conectividad con el servidor
        run: |
          echo "Intentando conectar con el servidor en ${{ env.BASE_URL }}..."
          for i in {1..20}; do
            if curl -s "${{ env.BASE_URL }}/api/health" > /dev/null; then
              echo "âœ… ConexiÃ³n exitosa con el servidor"
              exit 0
            fi
            echo "â³ Intento $i/20..."
            sleep 3
          done
          echo "âŒ No se pudo conectar con el servidor"
          exit 1

      - name: â˜ï¸ Ejecutar pruebas K6 en Grafana Cloud (FPS API)
        run: |
          cd pruebas_k6
          echo "ğŸš€ Ejecutando pruebas de carga para FPS Survival API..."
          echo "   ğŸ“Š BASE_URL: ${{ env.BASE_URL }}"
          echo "   â±ï¸  DURACIÃ“N: ${{ env.TEST_DURATION }}"
          
          k6 cloud run fps-api-test.js
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
          BASE_URL: ${{ env.BASE_URL }}
          TEST_DURATION: ${{ env.TEST_DURATION }}

      - name: ğŸ“Š Confirmar ejecuciÃ³n
        if: always()
        run: |
          echo "âœ… Pruebas enviadas a Grafana Cloud K6"
          echo "ğŸ“Š Resultados disponibles en:"
          echo "   ğŸ‘‰ https://grafana.com/a/k6-app"
          echo "   (Abre tu stack y ve a K6 Tests â†’ Runs)"

      - name: ğŸ“¤ Subir logs como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-test-logs
          path: |
            pruebas_k6/*.log
          retention-days: 30
          if-no-files-found: ignore
