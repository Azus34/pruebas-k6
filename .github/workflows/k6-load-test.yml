name: K6 Load Testing Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL base de la aplicación a probar'
        required: false
        default: 'http://localhost'
      test_duration:
        description: 'Duración de la prueba'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - extended

jobs:
  k6_load_test:
    name: Ejecutar Pruebas de Carga K6
    runs-on: ubuntu-latest
    environment: K6_CLOUD_TOKEN

    steps:
      - name: 📦 Checkout del repositorio
        uses: actions/checkout@v4

      - name: ⚙️ Instalar K6 con apt
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3232A
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6-stable.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: ✅ Verificar instalación de K6
        run: k6 version

      - name: 🔐 Configurar token de Grafana Cloud
        run: |
          echo "Configurando token de Grafana Cloud via variable de entorno..."
          echo "K6_CLOUD_TOKEN está configurado: $(if [ -n "$K6_CLOUD_TOKEN" ]; then echo 'Sí'; else echo 'No - ERROR: Token no disponible'; fi)"
          if [ -z "$K6_CLOUD_TOKEN" ]; then
            echo "ERROR: El secret K6_CLOUD_TOKEN no está configurado en GitHub Actions"
            exit 1
          fi
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}

      - name: 🎯 Configurar variables de entorno
        run: |
          echo "BASE_URL=${{ github.event.inputs.base_url || 'http://localhost' }}" >> $GITHUB_ENV
          echo "TEST_DURATION=${{ github.event.inputs.test_duration || 'standard' }}" >> $GITHUB_ENV

      - name: ☁️ Ejecutar pruebas K6 en Grafana Cloud
        run: |
          cd pruebas_k6
          echo "🚀 Ejecutando pruebas en Grafana Cloud..."
          k6 cloud run my-script.js
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
          BASE_URL: ${{ env.BASE_URL }}
          TEST_DURATION: ${{ env.TEST_DURATION }}

      - name: 📊 Confirmar ejecución
        if: always()
        run: |
          echo "✅ Pruebas enviadas a Grafana Cloud K6"
          echo "📊 Resultados disponibles en:"
          echo "   👉 https://grafana.com/a/k6-app"
          echo "   (Abre tu stack y ve a K6 Tests → Runs)"

      - name: 📤 Subir logs como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-test-logs
          path: |
            pruebas_k6/*.log
          retention-days: 30
          if-no-files-found: ignore