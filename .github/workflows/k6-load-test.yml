name: K6 Load Testing Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  k6_load_test:
    name: Ejecutar Pruebas de Carga K6
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar K6
        run: |
          cd /tmp
          wget -q https://github.com/grafana/k6/releases/download/v0.53.0/k6-v0.53.0-linux-amd64.tar.gz
          tar xzf k6-v0.53.0-linux-amd64.tar.gz
          sudo mv k6-v0.53.0-linux-amd64/k6 /usr/local/bin/
          rm -rf k6-v0.53.0-linux-amd64
          k6 version

      - name: ğŸ“¦ Instalar dependencias de Node.js
        run: |
          cd fps-api
          npm install

      - name: ğŸš€ Iniciar servidor FPS API
        run: |
          cd fps-api
          npm start > server.log 2>&1 &
          SERVER_PID=$!
          echo "Servidor iniciado con PID: $SERVER_PID"
          sleep 5
          
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… Servidor estÃ¡ corriendo"
          else
            echo "âŒ Servidor no se iniciÃ³"
            cat server.log
            exit 1
          fi

      - name: ğŸ§ª Verificar conectividad
        run: |
          echo "Esperando que el servidor responda..."
          for i in {1..20}; do
            if curl -s -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Servidor listo en intento $i"
              exit 0
            fi
            echo "Intento $i..."
            sleep 1
          done
          echo "âŒ Servidor no responde"
          exit 1

      - name: â˜ï¸ Ejecutar pruebas K6
        run: |
          cd pruebas_k6
          k6 cloud run fps-api-test.js
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}

      - name: ğŸ“Š Listo
        if: always()
        run: |
          echo "Pruebas completadas"
          echo "Resultados: https://grafana.com/a/k6-app"

      - name: ğŸ“¤ Guardar logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-logs
          path: fps-api/server.log
          retention-days: 30
          if-no-files-found: ignore
